<html>

<head>
    <title>GoodEnough POKEY Emulator, v2</title>
    <script>
        const reg_names =  ["audf1", "audc1", "audf2", "audc2", "audf3", "audc3", "audf4", "audc4", "audctl"];

        function createAnalyser(audioContext) {
            var analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
            var bufferLength = analyser.frequencyBinCount;
            var dataArray = new Uint8Array(bufferLength);
            var freqArray = new Uint8Array(bufferLength);

            var scopeCanvas = document.getElementById("oscilloscope");
            var scopeCanvasCtx = scopeCanvas.getContext("2d");

            var spectrumCanvas = document.getElementById("spectrum");
            var spectrumCanvasCtx = spectrumCanvas.getContext("2d");

            function drawScope() {
                requestAnimationFrame(drawScope);

                // setTimeout(drawScope, 500);

                analyser.getByteTimeDomainData(dataArray);

                scopeCanvasCtx.fillStyle = "rgb(0, 0, 0)";
                scopeCanvasCtx.fillRect(0, 0, scopeCanvas.width, scopeCanvas.height);

                scopeCanvasCtx.lineWidth = 2;
                scopeCanvasCtx.strokeStyle = "rgb(0, 200, 0)";

                scopeCanvasCtx.beginPath();

                var sliceWidth = scopeCanvas.width * 1.0 / bufferLength;
                var x = 0;
                var last_sample = null;
                var offset = null;
                scopeCanvasCtx.moveTo(0, scopeCanvas.height / 2);
                for (var i = 0; i < bufferLength; i++) {
                    var v = dataArray[i] / 128.0;
                    if(offset == null && last_sample != null && last_sample < 1.0 && v >= 1.0) {
                        offset = x;
                    }
                    var y = v * scopeCanvas.height / 2;
                    if(offset != null && x >= offset) {
                        if (x == offset) {
                            scopeCanvasCtx.moveTo(x - offset, y);
                        } else {
                            scopeCanvasCtx.lineTo(x - offset, y);
                        }
                    }

                    x += sliceWidth;
                    last_sample = v;
                }
                if(offset==null) {
                    scopeCanvasCtx.lineTo(scopeCanvas.width, scopeCanvas.height / 2);
                }
                scopeCanvasCtx.stroke();
            }

            function drawSpectrum() {

                requestAnimationFrame(drawSpectrum);

                analyser.getByteFrequencyData(freqArray);

                spectrumCanvasCtx.fillStyle = "rgb(0, 0, 0)";
                spectrumCanvasCtx.fillRect(0, 0, spectrumCanvas.width, spectrumCanvas.height);
                spectrumCanvasCtx.fillStyle = "rgb(200, 0, 0)";
                for (var i = 0; i < bufferLength; i++) {
                    if(freqArray[i]) {
                        spectrumCanvasCtx.fillRect(i, spectrumCanvas.height- spectrumCanvas.height * freqArray[i] / 256, 1, spectrumCanvas.height);
                    }
                }
            }

            drawScope();
            drawSpectrum();

            return analyser
        }

        async function init() {
            const audioContext = new AudioContext({
                sampleRate: 48000,
                latencyHint:'playback'
            })
            await audioContext.audioWorklet.addModule('pokey.js')
            const pokeyNode = new AudioWorkletNode(audioContext, 'POKEY')
            analyser = createAnalyser(audioContext);
            analyser.connect(audioContext.destination);
            // pokeyNode.connect(audioContext.destination)
            pokeyNode.connect(analyser);
            window.pokey_port = pokeyNode.port
            window.audio_context = audioContext
            hash_to_pokey()


        }
        function get_reg(name) {
            let input = document.querySelector("#" + name);
            let value = parseInt(input.value, 16) || 0;
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            var hex = value.toString(16);
            if (hex.length < 2) {
                hex = "0" + hex;
            }
            input.value = hex;
            return hex
        }
        function set_reg(name, value) {
            let input = document.querySelector("#" + name);
            input.value = value
        }
        function send_regs(reg) {
            window.audio_context.resume();
            document.location.hash = '#' + reg_names.map(get_reg).join("_");
        }
        function hash_to_pokey() {
            let regs = document.location.hash.substring(1).split("_")
            if(regs && regs.length == 9) {
                regs.map((v, i) => {
                set_reg(reg_names[i], v);
                })
                window.pokey_port.postMessage(regs.map((v) => parseInt(v, 16)));
            }
        }
    </script>
    <style>
        input {
            width: 3em
        }
        canvas {
            margin: 1em;
        }
    </style>
</head>

<body onhashchange="hash_to_pokey()" onload="init()">
    <table>
        <tr>
            <td>AUDCTL</td>
            <td><input onchange="send_regs()" id="audctl" value="00" /></td>
        </tr>
        <tr>
            <td></td>
            <td>AUDC</td>
            <td>AUDF</td>
        </tr>
        <tr>
            <td>channel 1</td>
            <td><input onchange="send_regs()" id="audc1" value="00" /></td>
            <td><input onchange="send_regs()" id="audf1" value="00" /></td>
        </tr>
        <tr>
            <td>channel 2</td>
            <td><input onchange="send_regs()" id="audc2" value="00" /></td>
            <td><input onchange="send_regs()" id="audf2" value="00" /></td>
        </tr>
        <tr>
            <td>channel 3</td>
            <td><input onchange="send_regs()" id="audc3" value="00" /></td>
            <td><input onchange="send_regs()" id="audf3" value="00" /></td>
        </tr>
        <tr>
            <td>channel 4</td>
            <td><input onchange="send_regs()" id="audc4" value="00" /></td>
            <td><input onchange="send_regs()" id="audf4" value="00" /></td>
        </tr>
    </table>
    <button onclick="window.audio_context.resume()">enable audio</button>
    <br/>
    <canvas id="oscilloscope" width="1024" height="256">

    </canvas>

    <canvas id="spectrum" width="1024" height="128">

    </canvas>
</body>

</html>