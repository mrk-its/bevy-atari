pub trait PolyGenerator {
    fn compute(v: u32) -> u32;
    fn n_bits() -> u32;
    fn highest_bit() -> u32 {
        1 << (Self::n_bits() - 1)
    }
    fn size() -> usize {
        2_usize.pow(Self::n_bits()) - 1
    }
    fn as_vec() -> Vec<bool> {
        let mut out = Vec::with_capacity(Self::size());
        let mut v: u32 = Self::highest_bit();
        for _ in 0..Self::size() {
            out.push(v & 1 > 0);
            v = Self::compute(v);
        }
        out
    }
}

pub struct Poly4;

impl PolyGenerator for Poly4 {
    fn compute(v: u32) -> u32 {
        ((v + v) + (!((v >> 2) ^ (v >> 3)) & 1)) & 0x7fffffff
    }
    fn n_bits() -> u32 {
        4
    }
}

pub struct Poly5;

impl PolyGenerator for Poly5 {
    fn compute(v: u32) -> u32 {
        ((v + v) + (!((v >> 2) ^ (v >> 4)) & 1)) & 0x7fffffff
    }
    fn n_bits() -> u32 {
        5
    }
}

pub struct Poly9;

impl PolyGenerator for Poly9 {
    fn compute(v: u32) -> u32 {
        (v >> 1) + (((v << 8) ^ (v << 3)) & 0x100)
    }
    fn n_bits() -> u32 {
        9
    }
}

pub struct Poly17;

impl PolyGenerator for Poly17 {
    fn compute(v: u32) -> u32 {
        (v >> 1) + (((v << 16) ^ (v << 11)) & 0x10000)
    }
    fn n_bits() -> u32 {
        17
    }
}

pub trait Filter {
    fn add_sample(&mut self, value: f32);
    fn get(&self) -> f32;
}

pub struct FIRFilter {
    coefficients: &'static [f32],
    buffer: Vec<f32>,
    current_pos: usize,
}

impl FIRFilter {
    pub fn new(coefficients: &'static [f32]) -> Self {
        let buffer = Vec::from_iter(std::iter::repeat(0.0).take(coefficients.len()));
        Self {
            coefficients,
            buffer,
            current_pos: 0,
        }
    }
}

impl Filter for FIRFilter {
    fn add_sample(&mut self, value: f32) {
        self.buffer[self.current_pos] = value;
        self.current_pos = (self.current_pos + 1) % self.buffer.len();
    }

    fn get(&self) -> f32 {
        let len = self.buffer.len();
        let mut acc = 0.0;
        let mut j = self.current_pos;
        for i in 0..len {
            acc += self.coefficients[i] * self.buffer[j];
            j += 1;
            if j >= len {
                j = 0;
            }
        }
        acc
    }
}

pub struct FIRHalfBandFilter(FIRFilter);

impl FIRHalfBandFilter {
    pub fn new(coefficients: &'static [f32]) -> Self {
        Self(FIRFilter::new(coefficients))
    }
}

impl Filter for FIRHalfBandFilter {
    fn add_sample(&mut self, value: f32) {
        self.0.add_sample(value)
    }

    fn get(&self) -> f32 {
        let len = self.0.buffer.len();
        let mid = len / 2;
        let mut acc = 0.5 * self.0.buffer[(self.0.current_pos + mid) % len];
        let mut j = self.0.current_pos;
        let mut k = (self.0.current_pos + self.0.coefficients.len() - 1) % self.0.buffer.len();
        let mut i = 0;
        while i < mid {
            acc += self.0.coefficients[i] * (self.0.buffer[j] + self.0.buffer[k]);
            j = (j + 2) % len;
            k = (k + len - 2) % len;
            i += 2;
        }
        acc
    }
}

pub struct FilterCascade40_1 {
    sample_cnt: usize,
    fir2_1: FIRHalfBandFilter,
    fir2_2: FIRHalfBandFilter,
    fir2_3: FIRHalfBandFilter,
    fir5: FIRFilter,
}

impl Filter for FilterCascade40_1 {
    fn add_sample(&mut self, value: f32) {
        self.sample_cnt += 1;
        let i = self.sample_cnt;
        self.fir2_1.add_sample(value);
        if i % 2 == 0 {
            self.fir2_2.add_sample(self.fir2_1.get());
            if i % 4 == 0 {
                self.fir2_3.add_sample(self.fir2_2.get());
                if i % 8 == 0 {
                    self.fir5.add_sample(self.fir2_3.get());
                }
            }
        }
    }

    fn get(&self) -> f32 {
        self.fir5.get()
    }
}

impl Default for FilterCascade40_1 {
    fn default() -> Self {
        Self {
            sample_cnt: 0,
            fir2_1: FIRHalfBandFilter::new(FIR_HALF_BAND),
            fir2_2: FIRHalfBandFilter::new(FIR_HALF_BAND),
            fir2_3: FIRHalfBandFilter::new(FIR_HALF_BAND),
            fir5: FIRFilter::new(FIR_5_TO_1),
        }
    }
}

pub const FIR_HALF_BAND: &[f32] = &[
    0.006631578542146366,
    0.0,
    -0.051031250383516566,
    0.0,
    0.29440207570898513,
    0.5,
    0.29440207570898513,
    0.0,
    -0.051031250383516566,
    0.0,
    0.006631578542146366,
];
pub const FIR_5_TO_1: &[f32] = &[
    2.2055693741469678e-05,
    0.00016140587951149585,
    0.0004455947025289253,
    0.0010027491986913189,
    0.0019249046528200598,
    0.003292700177846668,
    0.005127062345683061,
    0.007360044107222422,
    0.009812053207538326,
    0.012190930665028552,
    0.014119154130111888,
    0.015191082320631741,
    0.015053869269425509,
    0.013497498642671905,
    0.010532963553996738,
    0.006435844129913317,
    0.0017367094269457202,
    -0.0028500511841174306,
    -0.006552965686958489,
    -0.008703832465625354,
    -0.008897095134987279,
    -0.007108265775657866,
    -0.003735936739822901,
    0.0004535423291632218,
    0.0044768183812528076,
    0.007352674908280225,
    0.008340990245320049,
    0.007142213251758996,
    0.004001258158233128,
    -0.0003205602839678702,
    -0.004710546325493503,
    -0.007975622821472588,
    -0.009156281544343947,
    -0.007802711848847073,
    -0.00413496541919464,
    0.000966745057404005,
    0.006154220399241479,
    0.009949084817547832,
    0.011146126195162328,
    0.00917646467750611,
    0.004325693794929819,
    -0.0022670044295789137,
    -0.008849484017916917,
    -0.013493348526984732,
    -0.014624220110211335,
    -0.011508122236123242,
    -0.004554623510358881,
    0.004666013275846754,
    0.013726246796241974,
    0.019917492427708898,
    0.020972903387322855,
    0.015760095424924746,
    0.004758484551244897,
    -0.009825300616758409,
    -0.024369438665459646,
    -0.03453989694364911,
    -0.036245472521959685,
    -0.02663411123433674,
    -0.004893820187556659,
    0.027345440347776473,
    0.06612941205977459,
    0.10581952392674725,
    0.14013585322134517,
    0.16338524385008033,
    0.1716074988924923,
    0.16338524385008033,
    0.14013585322134517,
    0.10581952392674725,
    0.06612941205977459,
    0.027345440347776473,
    -0.004893820187556659,
    -0.02663411123433674,
    -0.036245472521959685,
    -0.03453989694364911,
    -0.024369438665459646,
    -0.009825300616758409,
    0.004758484551244897,
    0.015760095424924746,
    0.020972903387322855,
    0.019917492427708898,
    0.013726246796241974,
    0.004666013275846754,
    -0.004554623510358881,
    -0.011508122236123242,
    -0.014624220110211335,
    -0.013493348526984732,
    -0.008849484017916917,
    -0.0022670044295789137,
    0.004325693794929819,
    0.00917646467750611,
    0.011146126195162328,
    0.009949084817547832,
    0.006154220399241479,
    0.000966745057404005,
    -0.00413496541919464,
    -0.007802711848847073,
    -0.009156281544343947,
    -0.007975622821472588,
    -0.004710546325493503,
    -0.0003205602839678702,
    0.004001258158233128,
    0.007142213251758996,
    0.008340990245320049,
    0.007352674908280225,
    0.0044768183812528076,
    0.0004535423291632218,
    -0.003735936739822901,
    -0.007108265775657866,
    -0.008897095134987279,
    -0.008703832465625354,
    -0.006552965686958489,
    -0.0028500511841174306,
    0.0017367094269457202,
    0.006435844129913317,
    0.010532963553996738,
    0.013497498642671905,
    0.015053869269425509,
    0.015191082320631741,
    0.014119154130111888,
    0.012190930665028552,
    0.009812053207538326,
    0.007360044107222422,
    0.005127062345683061,
    0.003292700177846668,
    0.0019249046528200598,
    0.0010027491986913189,
    0.0004455947025289253,
    0.00016140587951149585,
    2.2055693741469678e-05,
];

pub const FIR_37_TO_1: &[f32] = &[
    -0.09349821507735248,
    0.003666910567355903,
    0.0036151277883324537,
    0.0035799221411175353,
    0.003552242647927605,
    0.003542827033881285,
    0.0035426515413241907,
    0.0035520735940582087,
    0.003569618013347629,
    0.0035974373631003486,
    0.003632708493515057,
    0.0036738655873837325,
    0.0037189575861326573,
    0.0037681053189869747,
    0.003819940339882748,
    0.0038732029974407676,
    0.003926241364999738,
    0.0039780781033141015,
    0.004027204953874909,
    0.004072093429640854,
    0.004111633482933724,
    0.004145008295488616,
    0.004171330704066523,
    0.004189024633557977,
    0.004197313249896553,
    0.004195049333993395,
    0.004181436710680956,
    0.004154188589397751,
    0.004113548632279398,
    0.004059419988684275,
    0.003993299227443386,
    0.003910807222983513,
    0.003811898654149772,
    0.0036944665141468605,
    0.003570389880502825,
    0.0034251083331524102,
    0.0032891969007221066,
    0.0029434362816407223,
    0.0029359689430925088,
    0.0027372083348269627,
    0.0024994585198891057,
    0.0022389914495120605,
    0.001972732848411926,
    0.001697343014595121,
    0.001414783902719725,
    0.0011247825923963559,
    0.0008304109705764811,
    0.0005304666712575737,
    0.00022504290225006584,
    -0.00008589242788670133,
    -0.00040018439806973987,
    -0.0007168318959069872,
    -0.0010345781126983354,
    -0.001352288789958951,
    -0.0016679911664585927,
    -0.0019799853146573536,
    -0.0022865329986336193,
    -0.002585370288116768,
    -0.0028740990267505048,
    -0.0031504956628552066,
    -0.0034133098994903795,
    -0.0036603785887257922,
    -0.0038899840990163485,
    -0.0040999182032089975,
    -0.004289874078047064,
    -0.004456711316352827,
    -0.004597927496009218,
    -0.004709172105291624,
    -0.004793945555080395,
    -0.004850934034146558,
    -0.004882226702754321,
    -0.0048676915880072336,
    -0.004830724267858526,
    -0.004744211670717836,
    -0.004679845752613664,
    -0.0044872209617146264,
    -0.00430234915359917,
    -0.00409038228776031,
    -0.003844927750717906,
    -0.0035544479131191156,
    -0.0032232880186703053,
    -0.002852046995559706,
    -0.0024431940709126166,
    -0.0019959453275516293,
    -0.001513042408400861,
    -0.0009960858912993393,
    -0.0004468586472420972,
    0.00013468497575733034,
    0.000747343502326168,
    0.0013898357056942158,
    0.002060545939187186,
    0.0027583339521850565,
    0.0034815655317932417,
    0.0042282532497063706,
    0.004996676470669485,
    0.005784833181478376,
    0.006590326243003574,
    0.007409498803939983,
    0.008239792436886467,
    0.009078269029911153,
    0.009922770498384883,
    0.01076893124527478,
    0.011615595553595912,
    0.012460805625966303,
    0.013305023583902025,
    0.014138892161398034,
    0.014958547931464929,
    0.015754734373077763,
    0.016556371762352782,
    0.017321310785546867,
    0.01807662270944155,
    0.018778566736118836,
    0.019493785943272113,
    0.020160473805793944,
    0.020789547478532025,
    0.021381320969019128,
    0.021942018077760837,
    0.02246557368980795,
    0.022949096520486198,
    0.023388683621208155,
    0.023784029052037404,
    0.02413238032215285,
    0.024432325076989975,
    0.02468253796689992,
    0.02488349665568337,
    0.02503473364515759,
    0.02513582054039397,
    0.025186284074643815,
    0.025186284074643815,
    0.02513582054039397,
    0.02503473364515759,
    0.02488349665568337,
    0.02468253796689992,
    0.024432325076989975,
    0.02413238032215285,
    0.023784029052037404,
    0.023388683621208155,
    0.022949096520486198,
    0.02246557368980795,
    0.021942018077760837,
    0.021381320969019128,
    0.020789547478532025,
    0.020160473805793944,
    0.019493785943272113,
    0.018778566736118836,
    0.01807662270944155,
    0.017321310785546867,
    0.016556371762352782,
    0.015754734373077763,
    0.014958547931464929,
    0.014138892161398034,
    0.013305023583902025,
    0.012460805625966303,
    0.011615595553595912,
    0.01076893124527478,
    0.009922770498384883,
    0.009078269029911153,
    0.008239792436886467,
    0.007409498803939983,
    0.006590326243003574,
    0.005784833181478376,
    0.004996676470669485,
    0.0042282532497063706,
    0.0034815655317932417,
    0.0027583339521850565,
    0.002060545939187186,
    0.0013898357056942158,
    0.000747343502326168,
    0.00013468497575733034,
    -0.0004468586472420972,
    -0.0009960858912993393,
    -0.001513042408400861,
    -0.0019959453275516293,
    -0.0024431940709126166,
    -0.002852046995559706,
    -0.0032232880186703053,
    -0.0035544479131191156,
    -0.003844927750717906,
    -0.00409038228776031,
    -0.00430234915359917,
    -0.0044872209617146264,
    -0.004679845752613664,
    -0.004744211670717836,
    -0.004830724267858526,
    -0.0048676915880072336,
    -0.004882226702754321,
    -0.004850934034146558,
    -0.004793945555080395,
    -0.004709172105291624,
    -0.004597927496009218,
    -0.004456711316352827,
    -0.004289874078047064,
    -0.0040999182032089975,
    -0.0038899840990163485,
    -0.0036603785887257922,
    -0.0034133098994903795,
    -0.0031504956628552066,
    -0.0028740990267505048,
    -0.002585370288116768,
    -0.0022865329986336193,
    -0.0019799853146573536,
    -0.0016679911664585927,
    -0.001352288789958951,
    -0.0010345781126983354,
    -0.0007168318959069872,
    -0.00040018439806973987,
    -0.00008589242788670133,
    0.00022504290225006584,
    0.0005304666712575737,
    0.0008304109705764811,
    0.0011247825923963559,
    0.001414783902719725,
    0.001697343014595121,
    0.001972732848411926,
    0.0022389914495120605,
    0.0024994585198891057,
    0.0027372083348269627,
    0.0029359689430925088,
    0.0029434362816407223,
    0.0032891969007221066,
    0.0034251083331524102,
    0.003570389880502825,
    0.0036944665141468605,
    0.003811898654149772,
    0.003910807222983513,
    0.003993299227443386,
    0.004059419988684275,
    0.004113548632279398,
    0.004154188589397751,
    0.004181436710680956,
    0.004195049333993395,
    0.004197313249896553,
    0.004189024633557977,
    0.004171330704066523,
    0.004145008295488616,
    0.004111633482933724,
    0.004072093429640854,
    0.004027204953874909,
    0.0039780781033141015,
    0.003926241364999738,
    0.0038732029974407676,
    0.003819940339882748,
    0.0037681053189869747,
    0.0037189575861326573,
    0.0036738655873837325,
    0.003632708493515057,
    0.0035974373631003486,
    0.003569618013347629,
    0.0035520735940582087,
    0.0035426515413241907,
    0.003542827033881285,
    0.003552242647927605,
    0.0035799221411175353,
    0.0036151277883324537,
    0.003666910567355903,
    -0.09349821507735248,
];
