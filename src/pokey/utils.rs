pub trait PolyGenerator {
    fn compute(v: u32) -> u32;
    fn n_bits() -> u32;
    fn highest_bit() -> u32 {
        1 << (Self::n_bits() - 1)
    }
    fn size() -> usize {
        2_usize.pow(Self::n_bits()) - 1
    }
    fn as_vec() -> Vec<bool> {
        let mut out = Vec::with_capacity(Self::size());
        let mut v: u32 = Self::highest_bit();
        for _ in 0..Self::size() {
            out.push(v & 1 > 0);
            v = Self::compute(v);
        }
        out
    }
}

pub struct Poly4;

impl PolyGenerator for Poly4 {
    fn compute(v: u32) -> u32 {
        ((v + v) + (!((v >> 2) ^ (v >> 3)) & 1)) & 0x7fffffff
    }
    fn n_bits() -> u32 {
        4
    }
}

pub struct Poly5;

impl PolyGenerator for Poly5 {
    fn compute(v: u32) -> u32 {
        ((v + v) + (!((v >> 2) ^ (v >> 4)) & 1)) & 0x7fffffff
    }
    fn n_bits() -> u32 {
        5
    }
}

pub struct Poly9;

impl PolyGenerator for Poly9 {
    fn compute(v: u32) -> u32 {
        (v >> 1) + (((v << 8) ^ (v << 3)) & 0x100)
    }
    fn n_bits() -> u32 {
        9
    }
}

pub struct Poly17;

impl PolyGenerator for Poly17 {
    fn compute(v: u32) -> u32 {
        (v >> 1) + (((v << 16) ^ (v << 11)) & 0x10000)
    }
    fn n_bits() -> u32 {
        17
    }
}

pub struct FIRFilter {
    coefficients: &'static [f32],
    buffer: Vec<f32>,
    current_pos: usize,
}

impl FIRFilter {
    pub fn new(coefficients: &'static [f32]) -> Self {
        let buffer = Vec::from_iter(std::iter::repeat(0.0).take(coefficients.len()));
        Self {
            coefficients,
            buffer,
            current_pos: 0,
        }
    }
    pub fn add_sample(&mut self, value: f32) {
        self.buffer[self.current_pos] = value;
        self.current_pos = (self.current_pos + 1) % self.buffer.len();
    }
    #[allow(dead_code)]
    pub fn get_last(&self) -> f32 {
        self.buffer[(self.current_pos + self.buffer.len() - 1) % self.buffer.len()]
    }
    pub fn get(&self) -> f32 {
        let len = self.buffer.len();
        let mut acc = 0.0;
        let mut j = self.current_pos;
        for i in 0..len {
            acc += self.coefficients[i] * self.buffer[j];
            j += 1;
            if j >= len {
                j = 0;
            }
        }
        acc
    }
}

pub const FIR_37_TO_1: &[f32] = &[
    -0.09349821507735248,
    0.003666910567355903,
    0.0036151277883324537,
    0.0035799221411175353,
    0.003552242647927605,
    0.003542827033881285,
    0.0035426515413241907,
    0.0035520735940582087,
    0.003569618013347629,
    0.0035974373631003486,
    0.003632708493515057,
    0.0036738655873837325,
    0.0037189575861326573,
    0.0037681053189869747,
    0.003819940339882748,
    0.0038732029974407676,
    0.003926241364999738,
    0.0039780781033141015,
    0.004027204953874909,
    0.004072093429640854,
    0.004111633482933724,
    0.004145008295488616,
    0.004171330704066523,
    0.004189024633557977,
    0.004197313249896553,
    0.004195049333993395,
    0.004181436710680956,
    0.004154188589397751,
    0.004113548632279398,
    0.004059419988684275,
    0.003993299227443386,
    0.003910807222983513,
    0.003811898654149772,
    0.0036944665141468605,
    0.003570389880502825,
    0.0034251083331524102,
    0.0032891969007221066,
    0.0029434362816407223,
    0.0029359689430925088,
    0.0027372083348269627,
    0.0024994585198891057,
    0.0022389914495120605,
    0.001972732848411926,
    0.001697343014595121,
    0.001414783902719725,
    0.0011247825923963559,
    0.0008304109705764811,
    0.0005304666712575737,
    0.00022504290225006584,
    -0.00008589242788670133,
    -0.00040018439806973987,
    -0.0007168318959069872,
    -0.0010345781126983354,
    -0.001352288789958951,
    -0.0016679911664585927,
    -0.0019799853146573536,
    -0.0022865329986336193,
    -0.002585370288116768,
    -0.0028740990267505048,
    -0.0031504956628552066,
    -0.0034133098994903795,
    -0.0036603785887257922,
    -0.0038899840990163485,
    -0.0040999182032089975,
    -0.004289874078047064,
    -0.004456711316352827,
    -0.004597927496009218,
    -0.004709172105291624,
    -0.004793945555080395,
    -0.004850934034146558,
    -0.004882226702754321,
    -0.0048676915880072336,
    -0.004830724267858526,
    -0.004744211670717836,
    -0.004679845752613664,
    -0.0044872209617146264,
    -0.00430234915359917,
    -0.00409038228776031,
    -0.003844927750717906,
    -0.0035544479131191156,
    -0.0032232880186703053,
    -0.002852046995559706,
    -0.0024431940709126166,
    -0.0019959453275516293,
    -0.001513042408400861,
    -0.0009960858912993393,
    -0.0004468586472420972,
    0.00013468497575733034,
    0.000747343502326168,
    0.0013898357056942158,
    0.002060545939187186,
    0.0027583339521850565,
    0.0034815655317932417,
    0.0042282532497063706,
    0.004996676470669485,
    0.005784833181478376,
    0.006590326243003574,
    0.007409498803939983,
    0.008239792436886467,
    0.009078269029911153,
    0.009922770498384883,
    0.01076893124527478,
    0.011615595553595912,
    0.012460805625966303,
    0.013305023583902025,
    0.014138892161398034,
    0.014958547931464929,
    0.015754734373077763,
    0.016556371762352782,
    0.017321310785546867,
    0.01807662270944155,
    0.018778566736118836,
    0.019493785943272113,
    0.020160473805793944,
    0.020789547478532025,
    0.021381320969019128,
    0.021942018077760837,
    0.02246557368980795,
    0.022949096520486198,
    0.023388683621208155,
    0.023784029052037404,
    0.02413238032215285,
    0.024432325076989975,
    0.02468253796689992,
    0.02488349665568337,
    0.02503473364515759,
    0.02513582054039397,
    0.025186284074643815,
    0.025186284074643815,
    0.02513582054039397,
    0.02503473364515759,
    0.02488349665568337,
    0.02468253796689992,
    0.024432325076989975,
    0.02413238032215285,
    0.023784029052037404,
    0.023388683621208155,
    0.022949096520486198,
    0.02246557368980795,
    0.021942018077760837,
    0.021381320969019128,
    0.020789547478532025,
    0.020160473805793944,
    0.019493785943272113,
    0.018778566736118836,
    0.01807662270944155,
    0.017321310785546867,
    0.016556371762352782,
    0.015754734373077763,
    0.014958547931464929,
    0.014138892161398034,
    0.013305023583902025,
    0.012460805625966303,
    0.011615595553595912,
    0.01076893124527478,
    0.009922770498384883,
    0.009078269029911153,
    0.008239792436886467,
    0.007409498803939983,
    0.006590326243003574,
    0.005784833181478376,
    0.004996676470669485,
    0.0042282532497063706,
    0.0034815655317932417,
    0.0027583339521850565,
    0.002060545939187186,
    0.0013898357056942158,
    0.000747343502326168,
    0.00013468497575733034,
    -0.0004468586472420972,
    -0.0009960858912993393,
    -0.001513042408400861,
    -0.0019959453275516293,
    -0.0024431940709126166,
    -0.002852046995559706,
    -0.0032232880186703053,
    -0.0035544479131191156,
    -0.003844927750717906,
    -0.00409038228776031,
    -0.00430234915359917,
    -0.0044872209617146264,
    -0.004679845752613664,
    -0.004744211670717836,
    -0.004830724267858526,
    -0.0048676915880072336,
    -0.004882226702754321,
    -0.004850934034146558,
    -0.004793945555080395,
    -0.004709172105291624,
    -0.004597927496009218,
    -0.004456711316352827,
    -0.004289874078047064,
    -0.0040999182032089975,
    -0.0038899840990163485,
    -0.0036603785887257922,
    -0.0034133098994903795,
    -0.0031504956628552066,
    -0.0028740990267505048,
    -0.002585370288116768,
    -0.0022865329986336193,
    -0.0019799853146573536,
    -0.0016679911664585927,
    -0.001352288789958951,
    -0.0010345781126983354,
    -0.0007168318959069872,
    -0.00040018439806973987,
    -0.00008589242788670133,
    0.00022504290225006584,
    0.0005304666712575737,
    0.0008304109705764811,
    0.0011247825923963559,
    0.001414783902719725,
    0.001697343014595121,
    0.001972732848411926,
    0.0022389914495120605,
    0.0024994585198891057,
    0.0027372083348269627,
    0.0029359689430925088,
    0.0029434362816407223,
    0.0032891969007221066,
    0.0034251083331524102,
    0.003570389880502825,
    0.0036944665141468605,
    0.003811898654149772,
    0.003910807222983513,
    0.003993299227443386,
    0.004059419988684275,
    0.004113548632279398,
    0.004154188589397751,
    0.004181436710680956,
    0.004195049333993395,
    0.004197313249896553,
    0.004189024633557977,
    0.004171330704066523,
    0.004145008295488616,
    0.004111633482933724,
    0.004072093429640854,
    0.004027204953874909,
    0.0039780781033141015,
    0.003926241364999738,
    0.0038732029974407676,
    0.003819940339882748,
    0.0037681053189869747,
    0.0037189575861326573,
    0.0036738655873837325,
    0.003632708493515057,
    0.0035974373631003486,
    0.003569618013347629,
    0.0035520735940582087,
    0.0035426515413241907,
    0.003542827033881285,
    0.003552242647927605,
    0.0035799221411175353,
    0.0036151277883324537,
    0.003666910567355903,
    -0.09349821507735248,
];
