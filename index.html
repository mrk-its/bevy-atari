<html>

<head>
  <meta charset="utf-8" />
  <style>
    body {
      background: linear-gradient(135deg,
          white 0%,
          white 49%,
          black 49%,
          black 51%,
          white 51%,
          white 100%);
      background-repeat: repeat;
      background-size: 20px 20px;
    }

    canvas {
      background-color: white;
    }

    #canvas-container {
      margin: 0px auto;
      width: 768px;
    }

    .files > div {
      padding: 1em;
      margin: 1em;
      background-color: white;
      border: 2px solid black;
      position: relative;
    }
    .files > div label {
      float: left;
    }
    .files .actions {
      float: right;
    }
  </style>
  <script>
    const k_file_header = [150, 2, 96, 17, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 7, 20, 7, 76, 20, 7, 116, 137, 0, 0, 169, 70, 141, 198, 2, 208, 254, 160, 0, 169, 107, 145, 88, 32, 217, 7, 176, 238, 32, 196, 7, 173, 122, 8, 13, 118, 8, 208, 227, 165, 128, 141, 224, 2, 165, 129, 141, 225, 2, 169, 0, 141, 226, 2, 141, 227, 2, 32, 235, 7, 176, 204, 160, 0, 145, 128, 165, 128, 197, 130, 208, 6, 165, 129, 197, 131, 240, 8, 230, 128, 208, 2, 230, 129, 208, 227, 173, 118, 8, 208, 175, 173, 226, 2, 141, 112, 7, 13, 227, 2, 240, 14, 173, 227, 2, 141, 113, 7, 32, 255, 255, 173, 122, 8, 208, 19, 169, 0, 141, 226, 2, 141, 227, 2, 32, 174, 7, 173, 122, 8, 208, 3, 76, 60, 7, 169, 0, 133, 128, 133, 129, 133, 130, 133, 131, 173, 224, 2, 133, 10, 133, 12, 173, 225, 2, 133, 11, 133, 13, 169, 1, 133, 9, 169, 0, 141, 68, 2, 108, 224, 2, 32, 235, 7, 133, 128, 32, 235, 7, 133, 129, 165, 128, 201, 255, 208, 16, 165, 129, 201, 255, 208, 10, 32, 235, 7, 133, 128, 32, 235, 7, 133, 129, 32, 235, 7, 133, 130, 32, 235, 7, 133, 131, 96, 32, 235, 7, 201, 255, 208, 9, 32, 235, 7, 201, 255, 208, 2, 24, 96, 56, 96, 173, 9, 7, 13, 10, 7, 13, 11, 7, 240, 121, 172, 121, 8, 16, 80, 238, 119, 8, 208, 3, 238, 120, 8, 169, 49, 141, 0, 3, 169, 1, 141, 1, 3, 169, 82, 141, 2, 3, 169, 64, 141, 3, 3, 169, 128, 141, 4, 3, 169, 8, 141, 5, 3, 169, 31, 141, 6, 3, 169, 128, 141, 8, 3, 169, 0, 141, 9, 3, 173, 119, 8, 141, 10, 3, 173, 120, 8, 141, 11, 3, 32, 89, 228, 173, 3, 3, 201, 2, 176, 34, 160, 0, 140, 121, 8, 185, 128, 8, 170, 173, 9, 7, 208, 11, 173, 10, 7, 208, 3, 206, 11, 7, 206, 10, 7, 206, 9, 7, 238, 121, 8, 138, 24, 96, 160, 1, 140, 118, 8, 56, 96, 160, 1, 140, 122, 8, 56, 96, 0, 3, 0, 128, 0, 0, 0, 0, 0, 0];
    function store(key, filename, data) {
      localStorage[key] = btoa(data);
      localStorage[key + "_filename"] = filename;
      console.log("installed", key, filename, "length:", data.length);
      set_binary_data(key, filename, data);
      update_status();
    }

    function store_delete(key) {
      delete localStorage[key];
      delete localStorage[key + "_filename"];
      set_binary_data(key, "", []);
      update_status();
    }

    function xex2atr(data) {
      let n_sectors = Math.floor((data.length + 127) / 128) + 3;
      let size = n_sectors * 128 / 16; // size in paragraphs;
      let size_h = Math.floor(size / 256);
      let size_l = size % 256;
      let atr_buf = new Uint8Array(n_sectors * 128 + 16);
      atr_buf.set(k_file_header, 0);
      atr_buf.set(data, k_file_header.length);
      atr_buf[2] = size_l;
      atr_buf[3] = size_h;
      atr_buf[25] = data.length % 256;
      atr_buf[26] = Math.floor(data.length / 256);
      return atr_buf;
    }
    function eject(event) {
      event.preventDefault();
      store_delete(event.target.parentNode.parentNode.attributes.id.value);
    }
    function set_file(filename, data) {
      if (filename.toLowerCase().endsWith(".rom")) {
        console.log(filename, data);
        if (data.length >= 10 * 1024) {
          store("osrom", filename, data);
        } else if (data.length == 8192) {
          store("basic", filename, data);
        } else {
          console.warn("invalid length of rom file", data.length);
        }
      } else if (filename.toLowerCase().endsWith(".state")) {
        set_binary_data("state", filename, data);
      } else if (filename.toLowerCase().endsWith(".atr")) {
        let is_valid = (data[0] == 0x96 && data[1] == 0x02 && data[4] == 128 && data[5] == 0);
        if(is_valid) {
          store("disk_1", filename, data);
        } else {
          console.warn("unsupported ATR file");
        }
      } else if (filename.toLowerCase().endsWith(".xex")) {
        let atr_filename = filename.substring(0, filename.length - 4) + "[auto-k-file].atr";
        store("disk_1", atr_filename, xex2atr(data));
      }
    }

    function on_drop_handler(event) {
      event.preventDefault();
      let url = event.dataTransfer.getData("text/plain");
      if (url) {
        let url_obj = new URL(url);
        let path = decodeURIComponent(url_obj.pathname);
        let fn = path.split("/");
        fn = fn[fn.length - 1];
        fetch("https://cors-anywhere.herokuapp.com/" + url).then(
          r => r.arrayBuffer()
        ).then(
          data => set_file(fn, new Uint8Array(data))
        );
      } else {
        let name = event.dataTransfer.files[0].name;
        event.dataTransfer.files[0].arrayBuffer().then(function (data) {
          set_file(name, new Uint8Array(data));
          // load_file(, name);
        })
      }
    }

    function update_status() {
      document.querySelector("#disk_1 span").innerText = localStorage.disk_1_filename || 'empty';
      document.querySelector("#osrom span").innerText = localStorage.osrom_filename || 'default';
      document.querySelector("#basic span").innerText = localStorage.basic_filename || 'default';
    }
    function init_binary_data(key) {
      let data = localStorage[key];
      let filename = localStorage[`${key}_filename`];
      if (data && filename) {
        let d = new Uint8Array(atob(data).split(","));
        set_binary_data(key, filename, d);
      }
    }

  </script>

  <script type="module">
    import init, { set_joystick, set_binary_data, cmd, reset } from './target/wasm.js'
    async function run() {
      try {
        await init()
      } catch (e) {
      }
      // function random_moves() {
      //   // set_joystick param: port, up, down, left, right, fire
      //   set_joystick(0, Math.random()<0.5, Math.random()<0.5, Math.random()<0.5, Math.random()<0.5, Math.random()<0.2);
      //   setTimeout(random_moves, 100)
      // }
      // random_moves();
      window.set_binary_data = set_binary_data;
      window.cmd = cmd;
      window.reset = reset;
      init_binary_data("osrom");
      init_binary_data("basic");
      init_binary_data("disk_1");
      update_status();
    }
    run();

    function auto_focus() {
      let canvas = document.getElementsByTagName("canvas");
      if (!canvas.length) {
        setTimeout(auto_focus, 100);
      } else {
        canvas[0].focus();
      }
    }
    auto_focus()
  </script>
</head>


<body ondrop="on_drop_handler(event);" ondragover="event.preventDefault();">
  <div id="canvas-container">
    <canvas id="bevy-canvas" tabindex="0" data-raw-handle="1" alt="bevy" cursor="auto"></canvas>
    <div class="files">
      <div id="osrom">
        OSROM: <span></span>
        <div class="actions"><a onclick="eject(event)" href="#">Default</a></div>
      </div>
      <div id="basic">
        Basic: <span></span>
        <div class="actions"><a onclick="eject(event)" href="#">Default</a></div>
      </div>
      <div id="disk_1">
        Disk 1: <span></span>
        <div class="actions"><a onclick="eject(event)" href="#">Eject</a></div>
      </div>
    </div>
  </div>
</body>

</html>