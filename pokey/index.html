<html>

<head>
    <title>GoodEnough POKEY Emulator, v2</title>
    <script src='https://code.jquery.com/jquery-latest.min.js' type='text/javascript'></script>
    <script type="module">
        import { createAnalyser } from './analyser.js'
        import { SAPPlayer} from './sap.js'
        const reg_names = ["audf1", "audc1", "audf2", "audc2", "audf3", "audc3", "audf4", "audc4", "audctl"];

        async function initAudio(latencyHint) {
            var latencyHint = parseFloat(localStorage.latencyHint);
            if(!(latencyHint>=0)) latencyHint = localStorage.latencyHint || "playback";
            const audioContext = new AudioContext({
                sampleRate: 48000,
                latencyHint,
            })
            $("#latency").text(audioContext.baseLatency)
            await audioContext.audioWorklet.addModule('pokey.js')
            const pokeyNode = new AudioWorkletNode(audioContext, 'POKEY')
            var analyser = createAnalyser(audioContext);
            analyser.node.connect(audioContext.destination);
            // pokeyNode.connect(audioContext.destination)
            pokeyNode.connect(analyser.node);
            window.pokey_port = pokeyNode.port
            window.audio_context = audioContext

            init_ui();

            let tick = () => {
                sapPlayer.tick();
                analyser.draw();
                requestAnimationFrame(tick);
            }
            tick();
            hash_to_pokey()
        }
        function hex2(value) {
            if (value < 0) value = 0;
            if (value > 255) value = 255;
            var hex = value.toString(16);
            if (hex.length < 2) {
                hex = "0" + hex;
            }
            return hex;
        }
        function get_reg(name) {
            let input = document.querySelector("#" + name);
            let value = parseInt(input.value, 16) || 0;
            let hex = hex2(value);
            input.value = hex;
            return hex
        }
        function set_reg(name, value) {
            let input = document.querySelector("#" + name);
            input.value = value
        }
        function send_regs() {
            window.audio_context.resume();
            document.location.hash = '#' + reg_names.map(get_reg).join("_");
        }
        function regs_to_hash(regs) {
            document.location.hash = '#' + Array.from(regs).map(hex2).join("_");
        }
        function hash_to_pokey() {
            let hash = document.location.hash.substring(1);
            if(hash.startsWith("http")) {
                play_url(hash);
            }

            let regs = hash.split("_")
            if (regs && regs.length == 9) {
                regs.map((v, i) => {
                    set_reg(reg_names[i], v);
                })
                let msg = regs.map((v) => parseInt(v, 16));
                msg.push(window.audio_context.currentTime + 1.0);
                window.pokey_port.postMessage(msg);
            }
        }

        function handle_file(file) {
            audio_context.resume();
            let name = file.name;
            file.arrayBuffer().then(buffer => window.sapPlayer.load(buffer));
        }
        function handle_local_file(event) {
            event.preventDefault();
            event.stopPropagation();
            for (let file of event.target.files) {
                handle_file(file);
                document.location.hash='#'
            }
        }
        function play_url(url) {
            fetch("https://atari.ha.sed.pl/" + url)
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    window.sapPlayer.load(buffer)
                });
        }

        function init_ui() {
            $("#latency-hint").change(e => {
                localStorage['latencyHint'] = e.target.value;
            }).val(localStorage['latencyHint'] || 'playback');
            $('#ua').text(window.navigator.userAgent);
            $('#pokey_regs input').change(send_regs);
            $('body').click(() => {
                window.audio_context.resume();
            })
            $('input[type=file]').change(handle_local_file);
            $(window).bind("hashchange", hash_to_pokey);

            $('html').on("dragover", function (event) {
                event.preventDefault();
                event.stopPropagation();
            });

            $('html').on("dragleave", function (event) {
                event.preventDefault();
                event.stopPropagation();
            });

            $('html').on("drop", function (event) {
                event.preventDefault();
                event.stopPropagation();
                let url = event.originalEvent.dataTransfer.getData("text/plain");
                if (url) {
                    document.location.hash = '#' + url;
                    return;
                }
                if (event.originalEvent.dataTransfer.files) {
                    // Use DataTransferItemList interface to access the file(s)
                    for (var i = 0; i < event.originalEvent.dataTransfer.files.length; i++) {
                        // If dropped items aren't files, reject them
                        const file = event.originalEvent.dataTransfer.files[i];
                        handle_file(file)
                        document.location.hash='#'
                    }
                }
            });
            let seek = $('#player .seek').bind('input', event => sapPlayer.seek(event.target.value));
            let position_info = $('#player .position-info');

            $('#player .play').click(() => sapPlayer.play());
            $('#player .pause').click(() => sapPlayer.pause());
            $('#player .stop').click(() => sapPlayer.stop());
            $('#player .prev').click(() => sapPlayer.prev());
            $('#player .next').click(() => sapPlayer.next());

            $(window).bind("sap_player", event => {
                let data = event.originalEvent.data;
                if(data.pokey_regs) {
                    let regs = Array.from(data.pokey_regs);
                    regs.slice(0, 9).map(hex2).map((v, i) => {
                        set_reg(reg_names[i], v);
                    })
                    if(data.state == "paused") {
                        regs_to_hash(regs);
                    }
                }
                seek[0].max = data.frame_cnt > 0 ? data.frame_cnt - 1 : 0;
                seek.val(data.current_frame);
                position_info.text(`${data.current_frame} / ${data.frame_cnt}`)
            });
        }

        window.sapPlayer = new SAPPlayer();
        window.send_regs = send_regs;
        window.hash_to_pokey = hash_to_pokey;

        initAudio("playback");

        // document.addEventListener('visibilitychange', function() {
        //     if (document.hidden) {
        //         window.audio_context.suspend();
        //     } else {
        //         window.audio_context.resume();
        //     }
        // });
    </script>
    <style>
        #pokey_regs input {
            width: 3em
        }

        canvas {
            margin: 1em;
        }

        input[type=range] {
            margin: 1em;
        }
    </style>
</head>

<body>
    <table id="pokey_regs">
        <tr>
            <td></td>
            <td>AUDF</td>
            <td>AUDC</td>
        </tr>
        <tr>
            <td>channel 1</td>
            <td><input id="audf1" value="00" /></td>
            <td><input id="audc1" value="00" /></td>
        </tr>
        <tr>
            <td>channel 2</td>
            <td><input id="audf2" value="00" /></td>
            <td><input id="audc2" value="00" /></td>
        </tr>
        <tr>
            <td>channel 3</td>
            <td><input id="audf3" value="00" /></td>
            <td><input id="audc3" value="00" /></td>
        </tr>
        <tr>
            <td>channel 4</td>
            <td><input id="audf4" value="00" /></td>
            <td><input id="audc4" value="00" /></td>
        </tr>
        <tr>
            <td>AUDCTL</td>
            <td><input id="audctl" value="00" /></td>
        </tr>
    </table>
    <br />
    <div id="player" style="width: 1024px">
        <canvas id="oscilloscope" width="1024" height="256">

        </canvas>
        <input type="file" />
        <button class="prev">&lt;&lt;</button>
        <button class="play">play</button>
        <button class="pause">pause</button>
        <button class="stop">stop</button>
        <button class="next">&gt;&gt;</button>
        <label class="position-info"></label>
        <input type="range" style="width: 100%" class="seek" max="0", value="0" />
    </div>
    latency hint: <input id="latency-hint" value="playback" />
    <p>Latency: <span id="latency"></span></p>
    <p>UserAgent: <span id="ua"></span></p>
</body>

</html>